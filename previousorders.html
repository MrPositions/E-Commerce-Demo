<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previous Orders</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Atlantic+BC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .order-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .order-date {
            font-size: 0.9rem;
            color: #555;
        }

        .reorder-btn {
            background-color: #A97848;
            color: white;
            border: none;
            cursor: pointer;
        }

        .reorder-btn:hover {
            background-color: #A9815E;
        }
    </style>
</head>
<body>
<!-- Header Section -->
<header class="header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-3 text-center text-md-left">
                <a href="index.html" class="logo d-none d-md-block"> <!-- Hide logo on mobile -->
                    <img src="images/logo1.png" alt="Sewn Elegance Logo" class="img-fluid">
                </a>
            </div>
            <div class="col-md-6 text-center">
                <!-- Hidden Navigation on Mobile -->
                <nav class="nav d-none d-md-block">
                    <ul class="list-unstyled d-flex justify-content-center mb-0">
                        <li class="mx-4"><a href="index.html">Home</a></li>
                        <li class="mx-4"><a href="products.html">Products</a></li>
                        <li class="mx-4"><a href="about.html">About Us</a></li>
                        <li class="mx-4"><a href="contact.html">Contact</a></li>
                    </ul>
                </nav>
            </div>
            <div class="col-md-3 text-md-text-center">
                <!-- Hidden Icons on Mobile -->
                <div class="header-icons d-none d-md-flex justify-content-end align-items-center">
                    <!-- Icons -->
                    <a href="#" class="icon mx-2" id="userIcon">
                        <i class="fas fa-user"></i>
                    </a>
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="previousorders.html">Previous Orders</a>
                        <a href="login.html">Sign In/Sign Up</a>
                    </div>
                    <a href="ordertracking.html" class="icon mx-2">
                        <i class="fas fa-truck"></i>
                    </a>
                    <a href="#" class="icon mx-2 cart-icon" id="pc-cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-badge" id="pc-cart-badge">0</span> <!-- Badge for item count -->
                    </a>
                </div>
            </div>

            <!-- Mobile Header for Small Screens -->
            <div class="col-12 d-md-none">
                <div class="row align-items-center">
                    <div class="col-4 text-left">
                        <a href="index.html" class="logo">
                            <img src="images/logo1.png" alt="Sewn Elegance Logo" class="img-fluid" style="max-width: 80px;"> <!-- Smaller logo -->
                        </a>
                    </div>
                    <div class="col-4 text-center">
                        <!-- Cart Icon in Center -->
                        <a href="#" class="icon cart-icon" id="mobile-cart-icon">
                            <i class="fas fa-shopping-cart" style="color: #D1A162; font-size: 1.5rem;"></i>
                            <span class="cart-badge" id="mobile-cart-badge">0</span> <!-- Badge for item count -->
                        </a>
                    </div>
                    <div class="col-4 text-right">
                        <!-- Hamburger Menu for Mobile -->
                        <div class="hamburger-menu">
                            <div class="hamburger-icon">â˜°</div>
                            <div class="mobile-menu hidden" id="mobile-menu">
                                <ul class="list-unstyled">
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="products.html">Products</a></li>
                                    <li><a href="about.html">About Us</a></li>
                                    <li><a href="contact.html">Contact</a></li>
                                    <li><a href="previousorders.html">Previous Orders</a></li>
                                    <li><a href="ordertracking.html">Order Tracking</a></li>
                                    <li><a href="login.html">Sign In/Sign Up</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Main Section -->
    <main class="container mt-4 text-center">
        <h1>Previous Orders</h1>
        <p class="lead">Here are your previous successful orders:</p>

        <div id="orders-container"></div>
    </main>

    <!-- Cart Section -->
    <aside class="cart-section">
        <!-- Cart Header -->
        <div class="cart-header">
            <h2>My Cart</h2>
        </div>
        <!-- Cart Main Area -->
        <div class="cart-content">
            <ul id="cart-items" class="list-unstyled">
                <!-- Cart items will be dynamically added here -->
            </ul>
        </div>

        <!-- Cart Footer -->
        <div class="cart-footer">
            <div class="total-section">
                <h3>Total: <span id="cart-total">$0.00</span></h3>
            </div>
            <div class="cart-buttons">
                <button class="btn btn-primary btn-lg continue-shopping" id="continue-shopping">Continue Shopping</button>
                <button class="btn btn-danger btn-lg proceed-to-checkout" id="proceed-to-checkout">Proceed to Checkout</button>
            </div>
        </div>
    </aside>

    <!-- Footer Section -->
    <footer class="footer text-center py-3">
        <p>&copy; 2024 Sewn Elegance. All rights reserved.</p>
        <p>Development and Design by <a href="https://mrpositions.github.io/Metal-Kittens-Portfolio/" class="footer-link" target="_blank" rel="noopener noreferrer">Metal Kittens Software Developers</a></p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="functionality.js"></script>
    <script>
        // Function to fetch and display previous orders
        async function fetchPreviousOrders() {
            try {
                const response = await fetch('/api/my-orders', {
                    method: 'GET',
                    credentials: 'include', // Include credentials for authentication
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }

                const orders = await response.json();
                displayPreviousOrders(orders);
            } catch (error) {
                console.error('Error fetching previous orders:', error);
                document.getElementById('orders-container').innerHTML = '<p>Error fetching previous orders. Please try again later.</p>';
            }
        }

        // Function to display previous orders
        function displayPreviousOrders(orders) {
            const ordersContainer = document.getElementById('orders-container');
            ordersContainer.innerHTML = '';

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<p>No previous orders found.</p>';
                return;
            }

            // Reverse the order to show the most recent first
            const sortedOrders = orders.reverse();

            sortedOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';

                const orderDate = document.createElement('div');
                orderDate.className = 'order-date';
                orderDate.textContent = `Order Date: ${new Date(order.orderDate).toLocaleDateString()}`;

                const itemsList = document.createElement('ul');
                itemsList.className = 'list-unstyled';
                order.items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${item.name} (Quantity: ${item.quantity})`;
                    itemsList.appendChild(listItem);
                });

                const reorderButton = document.createElement('button');
                reorderButton.className = 'reorder-btn';
                reorderButton.textContent = 'Reorder';
                reorderButton.onclick = () => repopulateCart(order.items);

                orderCard.appendChild(orderDate);
                orderCard.appendChild(itemsList);
                orderCard.appendChild(reorderButton);
                ordersContainer.appendChild(orderCard);
            });
        }

        // Function to repopulate the cart and redirect to checkout
        function repopulateCart(items) {
            // Retrieve the current cart from localStorage or initialize an empty array if none exists
            let cart = JSON.parse(localStorage.getItem('cartItems')) || [];

            items.forEach(item => {
                // Check if the item already exists in the cart
                const existingItemIndex = cart.findIndex(cartItem => cartItem.id === item.id);

                if (existingItemIndex > -1) {
                    // If the item exists, update the quantity
                    cart[existingItemIndex].quantity += item.quantity;
                } else {
                    // If the item doesn't exist, add it to the cart
                    cart.push({
                        id: item.id,
                        name: item.name, // Assuming the name is required in your cart structure
                        quantity: item.quantity,
                        style: item.style, // Include other necessary details like style, if applicable
                        // Add any other details necessary for each cart item
                    });
                }
            });

            // Save the updated cart back to localStorage
            localStorage.setItem('cartItems', JSON.stringify(cart));

            // Redirect to the checkout page
            window.location.href = 'checkout.html';
        }

        // Call the function on page load
        window.onload = function() {
            fetchPreviousOrders();
        };
    </script>
</body>
</html>
